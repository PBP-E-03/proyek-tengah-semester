{% extends 'base.html' %} {% block meta %}
<title>Donation Page</title>
{% endblock meta %}

{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
    
    if (window.location.pathname === "/donation/") {

    const alertBox = document.getElementById('alert-box')
    const form = document.getElementById('donation-form')

    const csrf = document.getElementsByName('csrfmiddlewaretoken')

    const nameDiv = document.getElementById("name-div")
    const emailDiv = document.getElementById("email-div")
    const phoneDiv = document.getElementById("phone-div") 

    const someoneCheckbox = document.getElementById('id_checkbox_donate_for_someone')

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var buttonList = document.getElementsByName("amount-button")

    for (let i = 0; i < buttonList.length; i++) {
        buttonList[i].addEventListener('click', ()=>{
            console.log(buttonList[i].value)
            document.getElementById('id_field_amount').value = buttonList[i].value
        })
    }

    

    someoneCheckbox.addEventListener('change', ()=>{
        if(someoneCheckbox.checked) {
            nameDiv.classList.remove("hidden")
            nameDiv.classList.add("flex")

            emailDiv.classList.remove("hidden")
            emailDiv.classList.add("flex")
            
            phoneDiv.classList.remove("hidden")
            phoneDiv.classList.add("flex")       
        }
        else {
            nameDiv.classList.add("hidden")
            nameDiv.classList.remove("flex")

            emailDiv.classList.add("hidden")
            emailDiv.classList.remove("flex")
            
            phoneDiv.classList.add("hidden")
            phoneDiv.classList.remove("flex") 

        }
    })


    const response = await fetch("{% url 'main:get_country' %}")
    const countries = await response.json()

    console.log(countries)

    const countrySelect = document.getElementById("id_field_country")
    const regionSelect = document.getElementById("id_field_region")

    const showRegions = async ()=> {
        regionSelect.innerHTML =""
        const code = countrySelect.value
        const response = await fetch(`/battuta/${code}`)
        const regions = await response.json()

        console.log(regions)
        

        for(let i=0; i<regions.length; i++) {
            regionSelect.innerHTML += `
        <option value="${regions[i].region}">${regions[i].region}</option>
        `
        }
    }

    countrySelect.addEventListener('click', showRegions)
    // regionSelect.addEventListener('click', showRegions)

    const closeAlertS = document.getElementById('close-success-alert')
    const closeAlertE = document.getElementById('close-error-alert')   
    
    closeAlertS.addEventListener('click', async (event)=>{
        $('#full-success-alert')
        .delay(100)
        .fadeOut()
    })
    closeAlertE.addEventListener('click', async (event)=>{
        $('#full-error-alert')
        .delay(100)
        .fadeOut()
    })


    form.addEventListener('submit', async (event)=>{
        event.preventDefault()

        const formData = {
            field_amount: parseInt( document.getElementById("id_field_amount").value),
            field_region: document.getElementById("id_field_region").value,
            field_country: document.getElementById("id_field_country").value,
            field_hopes: document.getElementById("id_field_hopes").value,
            checkbox_donate_for_someone: document.getElementById("id_checkbox_donate_for_someone").checked,
            field_name: document.getElementById("id_field_name").value,
            field_phone: document.getElementById("id_field_phone").value,
            field_email: document.getElementById("id_field_email").value,
        };

        console.log(formData)

        console.log(JSON.stringify(formData))

        const response = await fetch("{% url 'donation:submit_donation' %}", {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie("csrftoken"),
            },
            body: JSON.stringify(formData),
            
        })
        
        const message = await response.json()
        const alertMessage = message.message
        console.log(message)
        console.log(alertMessage)

        let $fullAlert = ""
        let $alertMessage = ""
        if (alertMessage === "Successfully submitted") {
            $alertMessage = $('success-alert-message')
            $fullAlert = $('#full-success-alert')
        }
        else {
            $alertMessage = $('error-alert-message')
            $fullAlert = $('#full-error-alert')
        }



        document.getElementById('success-alert-message').innerText = `You just donated ${formData['field_amount']} trees in ${formData['field_region']}.
        ${[message.coin]} coins have been added to your account`

        document.getElementById('error-alert-message').innerText = `Please check the fields and make sure you have filled everything required`

        $fullAlert 
        .delay(100)
        .fadeIn()
        .delay(3000)
        .fadeOut()
        window.moveTo(0,0)
    })




    }
    })

</script>
<div class="flex flex-col items-center w-full h-screen gap-6 p-5">

    <!-- ALERT BOXES -->
    <div class="flex flex-col gap-5">
        <div name="full-alert" id="full-success-alert" style="display: none;" class="w-full overflow-hidden rounded-lg bg-green-100 text-green-700 shadow-md shadow-green-500/20">
          <div class="flex">
            <div class="flex items-center gap-4 p-4">
              <div class="shrink-0">
                <svg width="32" height="32" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M20 16v-6h2v6a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2h8v2H8v12h12m-9.09-8.92L14 10.17l6.59-6.59L22 5l-8 8l-4.5-4.5l1.41-1.42M16 20v2H4a2 2 0 0 1-2-2V7h2v13h12Z"></path>
                </svg>
              </div>
              <div class="space-y-1">
                <p class="font-bold capitalize">
                  Donation Submitted!
                </p>
                <p id="success-alert-message" class="text-md">
                  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent et pharetra dui, sed varius tellus.
                </p>
              </div>
            </div>
            <div class="flex cursor-pointer items-center border-l border-green-200 px-4 hover:bg-green-200">
              <button class="" id="close-success-alert">
                <svg width="20" height="28" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div name="full-alert" id="full-error-alert" style="display: none;" class="max-w-lg overflow-hidden rounded-lg bg-rose-100 text-rose-700 shadow-md shadow-rose-500/20">
            <div class="flex">
              <div class="flex items-center gap-4 p-4">
                <div class="shrink-0">
                    <svg width="32" height="32" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12 13q.425 0 .713-.288Q13 12.425 13 12V7.975q0-.425-.287-.7Q12.425 7 12 7t-.712.287Q11 7.575 11 8v4.025q0 .425.288.7q.287.275.712.275Zm0 4q.425 0 .713-.288Q13 16.425 13 16t-.287-.713Q12.425 15 12 15t-.712.287Q11 15.575 11 16t.288.712Q11.575 17 12 17Zm0 5q-2.075 0-3.9-.788q-1.825-.787-3.175-2.137q-1.35-1.35-2.137-3.175Q2 14.075 2 12t.788-3.9q.787-1.825 2.137-3.175q1.35-1.35 3.175-2.138Q9.925 2 12 2t3.9.787q1.825.788 3.175 2.138q1.35 1.35 2.137 3.175Q22 9.925 22 12t-.788 3.9q-.787 1.825-2.137 3.175q-1.35 1.35-3.175 2.137Q14.075 22 12 22Zm0-10Zm0 8q3.325 0 5.663-2.337Q20 15.325 20 12t-2.337-5.663Q15.325 4 12 4T6.338 6.337Q4 8.675 4 12t2.338 5.663Q8.675 20 12 20Z"></path>
                    </svg>
                </div>
                <div class="space-y-1">
                  <p class="font-bold capitalize">
                    An Error Occured
                  </p>
                  <p id="error-alert-message" class="text-md">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent et pharetra dui, sed varius tellus.
                  </p>
                </div>
              </div>
              <div class="flex cursor-pointer items-center border-l border-rose-200 px-5 hover:bg-rose-200">
                <button class="" id="close-error-alert">
                  <svg width="20" height="28" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>

      </div>

    <div class="flex flex-col items-center justify-center whitespace-normal
        w-96 h-">

        <h1 class="font-montserrat font-bold text-4xl text-center
            text-[#56C969]">Donate The Trees</h1>
        <h2 class="font-montserrat font-bold text-xl text-center text-black">
            And Contribute to Environment by Making an Impact to the World </h2>
    </div>

    <div class="flex flex-row items-start justify-center w-full gap-5">

        <div class="w-1/3">
            <img
                src="https://drive.google.com/uc?export=view&id=1PEoE5n55JHIQW_h_YAi77FaOozY7dnAI"
                alt="Forest">



        </div>

        <!-- DONATION FORM -->
        <form
            method="POST"
            class="flex flex-col items-start gap-8 p-5 w-1/2 h-full shadow-lg
            rounded-xl"
            id="donation-form">
            {% csrf_token %}
            <!-- Donation amount -->
            <div class="flex flex-col items-start gap-2 w-full">
                <div>
                    <h1 class="font-montserrat font-bold text-md text-start
                        text-black">Donation Amount</h1>
                </div>
                <div class="flex flex-row gap-5">
                    <button name="amount-button" id="1-amount-button" value="1" class="button-primary">1 Tree</button>
                    <button name="amount-button" id="3-amount-button" value="3" class="button-primary">3 Trees</button>
                    <button name="amount-button" id="5-amount-button" value="5" class="button-primary">5 Trees</button>
                </div>


                <div class="py-1 w-full">

                    {{form.field_amount}}
                </div>
            </div>
            <!-- country and region -->
            <div class="flex flex-row items-start gap-9 w-full">
                <div class="flex flex-col items-start gap-2 w-1/2">
                    <h1 class="font-montserrat font-bold text-md text-start
                        text-black">Country</h1>
                    <!-- <input id="country" type="text" name="country" class="w-full
                        rounded-lg outline outline-offset-0 outline-2"
                        placeholder="Select the country" required
                        /> -->
                    {{form.field_country}}
                </div>
                <div class="flex flex-col items-start gap-2 w-1/2">
                    <h1 class="font-montserrat font-bold text-md text-start
                        text-black">Region</h1>
                    <!-- <input id="region" type="text" name="region" class="w-full
                        rounded-lg outline outline-offset-0 outline-2"
                        placeholder="Select the region" required
                        /> -->
                    {{form.field_region}}
                    
                </div>
            </div>
            <!-- donate for someone? -->
            <div class="flex flex-row gap-1 items-center">
                <!-- <input id="donate_for_someone" type="checkbox"
                    name="donate_for_someone" class="checked:bg-[#56C969]
                    indeterminate:bg-gray-300"> -->
                {{form.checkbox_donate_for_someone}}
                <p class="font-montserrat font-bold text-sm text-start
                    text-black">Donate for someone?</p>
            </div>

            <!-- name -->
            <div id="name-div" class="hidden flex-col w-full">
                <h1 class="font-montserrat font-bold text-md text-start
                    text-black">Name</h1>
                <!-- <input id="name" type="text" name="name" class="w-full
                    rounded-lg outline outline-offset-0 outline-2"
                    placeholder="John Doe" required
                    /> -->
                {{form.field_name}}
            </div>
            <!-- phone -->
            <div id="phone-div" class="hidden flex-col w-full">
                <h1 class="font-montserrat font-bold text-md text-start
                    text-black">Phone</h1>
                <!-- <input id="phone" type="text" name="phone" class="w-full
                    rounded-lg outline outline-offset-0 outline-2"
                    placeholder="0858XXXXXXXX" required
                    /> -->
                {{form.field_phone}}
            </div>
            <!-- email -->
            <div id="email-div" class="hidden flex-col w-full">
                <h1 class="font-montserrat font-bold text-md text-start
                    text-black">Email</h1>
                <!-- <input id="email" type="email" name="email" class="w-full
                    rounded-lg outline outline-offset-0 outline-2"
                    placeholder="example@gmail.com" required
                    /> -->
                {{form.field_email}}
            </div>

            <!-- hopes -->
            <div class="flex flex-col w-full">
                <h1 class="font-montserrat font-bold text-md text-start
                    text-black">Hopes</h1>
                <!-- <textarea id="hopes" name="hopes" class="w-full
                    rounded-lg outline outline-offset-0 outline-2" rows="4"
                    cols="50" placeholder="Your hopes for this donation"
                    required></textarea> -->
                {{form.field_hopes}}
            </div>
            <!-- donate button -->
            <div class="flex flex-row">
                <button type="submit" class="button-primary">Donate</button>
            </div>

            <div id="data" class="flex flex-col w-full items-start gap-4">
            </div>



        </form>



    </div>
</div>


{% endblock content %}